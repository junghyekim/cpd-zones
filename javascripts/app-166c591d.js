function score_compare(e,a){return e.score<a.score?-1:e.score>a.score?1:0}function render_template(e,a){var t=Mustache.render(e,a);$(".zone-results").append(t)}function flash_message(e,a){return"<div class='flash-"+e+"'><span>"+a+"</span></div>"}function build_query(e){return{SingleLine:e,f:"json",outSR:4326}}var southWest=L.latLng(34.9816,-85.4719),northEast=L.latLng(35.217,-85.0462),center=L.latLng(35.0657,-85.241),bounds=L.latLngBounds(southWest,northEast),tiles="//tile.stamen.com/terrain/{z}/{x}/{y}.jpg",geocoder="http://pwgis.chattanooga.gov/arcgis/rest/services/Locators/ChattGeo/GeocodeServer/findAddressCandidates",card_template=$("#card_template").html(),zone_name_template=$("#zone_name_template").html(),map_attribution='Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>. Zone data &copy; City of Chattanooga',marker,zones;L.Icon.Default.imagePath="images/leaflet-img";var map=L.map("map",{maxZoom:18,minZoom:11,maxBounds:bounds,center:center,zoom:12});L.tileLayer(tiles,{attribution:map_attribution}).addTo(map),omnivore.topojson("data/CPDZones.topojson").on("ready",function(){zones=this,this.eachLayer(function(e){e.setStyle(e.feature.properties)}),$("#input_form").submit(function(e){e.preventDefault(),void 0!==marker&&map.removeLayer(marker);var a=$("#query").val();$(".zone-results").html(""),$("#flash").html(""),$.ajax({url:geocoder,jsonp:"callback",dataType:"jsonp",timeout:5e3,data:build_query(a),success:function(e){if(e.candidates.length>0){var a=e.candidates.sort(score_compare)[e.candidates.length-1].location,t=L.latLng(a.y,a.x),r=leafletPip.pointInLayer(t,zones);if(r.length>0){var n=r[0],o=n.feature.properties;marker=new L.Marker(t),map.addLayer(marker),map.setView(t),render_template(zone_name_template,{zone:o.CPD_Zone.toLowerCase(),zone_upper:o.CPD_Zone}),render_template(card_template,{image:o.CAPT_IMG,name:o.CAPT,email:o.CAPT_EMAIL}),render_template(card_template,{image:o.LT_IMG,name:o.LT,email:o.LT_EMAIL})}else $("#flash").html(flash_message("error","Your address wasn't found in a region. Try another address."))}else $("#flash").html(flash_message("error","No results found for your address."))},error:function(){$("#flash").html(flash_message("error","There was an issue finding where you live. Please try again."))}})})}).addTo(map);